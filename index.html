<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Pulmoniq — Pediatric ARM</title>
  <meta name="description" content="Pulmoniq — Pediatric ARM. Apoio à decisão (educacional) para recrutamento alveolar em pediatria.">
  <meta name="theme-color" content="#0b1220"/>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="assets/icon-192.png.PNG">
  <link rel="apple-touch-icon" href="assets/icon-192.png.PNG">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Pulmoniq">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --bg1:#071025; --bg2:#0b1220; --card: rgba(17,26,46,.92);
      --line:#263554; --text:#e7eefc; --muted:#8aa0c2; --chip:#172341; --btn:#1f2f52;
      --good:#34d399; --warn:#fbbf24; --bad:#fb7185;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);font-family:var(--sans)}
    .wrap{max-width:1220px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    header img{width:54px;height:54px;border-radius:14px;border:1px solid var(--line);object-fit:cover;background:#0f172a}
    h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:13px;margin-top:2px;line-height:1.25}
    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:12px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:620px){.row{grid-template-columns:1fr}}
    label{display:block;color:var(--muted);font-size:12px;margin:0 0 6px}
    input,select,textarea{
      width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);
      background:#0c162d;color:var(--text);outline:none
    }
    textarea{min-height:88px;resize:vertical}
    button{background:var(--btn);border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
    button:hover{filter:brightness(1.07)}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:7px 10px;border-radius:999px;border:1px solid var(--line);background:var(--chip);font-size:12px}
    .badge{font-weight:900}
    .good{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .small{font-size:12px;color:var(--muted);line-height:1.45}
    .mono{font-family:var(--mono)}
    .box{border:1px solid var(--line);background:#0b1732;border-radius:14px;padding:10px}
    .tag{display:inline-block;margin:0 6px 6px 0;padding:5px 8px;border-radius:999px;border:1px solid var(--line);background:#0b1732;font-size:12px}
    .okbox{border:1px solid rgba(52,211,153,.45);background:rgba(52,211,153,.08);border-radius:14px;padding:10px}
    .warnbox{border:1px solid rgba(251,191,36,.45);background:rgba(251,191,36,.08);border-radius:14px;padding:10px}
    .badbox{border:1px solid rgba(251,113,133,.55);background:rgba(251,113,133,.10);border-radius:14px;padding:10px}
    .list{margin:8px 0 0 18px;color:#d9e6ff}
    .list li{margin:4px 0}
    canvas{width:100%;height:220px;border-radius:14px;border:1px solid var(--line);background:#0b1732}

    /* Tabs */
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tabbtn{padding:8px 10px;border-radius:12px;border:1px solid var(--line);background:#0b1732;color:var(--text);cursor:pointer}
    .tabbtn.active{background:var(--btn)}
    .tab{display:none}
    .tab.active{display:block}
    .cb{display:flex;gap:8px;align-items:center;margin-top:6px}
    .cb input{width:18px;height:18px}

    /* Decremental table */
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--line);padding:8px;font-size:12px}
    th{background:#0b1732;color:var(--text)}
    .rowbest{outline:2px solid rgba(52,211,153,.7); outline-offset:-2px}

    /* Print */
    @media print{
      body{background:#fff;color:#000}
      .card{background:#fff;border:1px solid #ddd}
      button,.tabs{display:none !important}
      textarea{border:1px solid #ddd}
    }
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <img src="assets/logo.png.PNG" alt="Pulmoniq logo">
    <div>
      <h1>Pulmoniq</h1>
      <div class="sub">Pediatric ARM · Cálculo / Manual / Fluxograma · Sugestão automática de protocolo · Alvos: DP≤15 e Pplat≤28 (soft) · PDF · PWA · Decremental até PEEP óptima</div>
    </div>
  </header>

  <div class="grid">
    <!-- INPUTS -->
    <div class="card">
      <h2 style="margin:0 0 10px;font-size:14px">Dados clínicos e ventilatórios</h2>

      <div class="row">
        <div>
          <label>Modo</label>
          <select id="mode">
            <option value="recruitable">Recrutável (ARDS/atelectasia) — ARM stepwise</option>
            <option value="obstructive">Obstrutivo (asma/bronquiolite) — sem ARM clássica</option>
          </select>
        </div>
        <div>
          <label>Preset</label>
          <select id="preset">
            <option value="ucip_default">UCIP (default)</option>
            <option value="ards">ARDS (mais agressivo, mantendo prudência)</option>
            <option value="hemo_fragile">Hemodinâmica frágil</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div><label>Diagnóstico / nota</label><input id="dx" placeholder="ex.: ARDS moderado; atelectasia pós-op..."></div>
        <div><label>Objectivo</label><input id="goal" placeholder="ex.: melhorar oxigenação; reduzir DP..."></div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div><label>Peso (kg)</label><input id="weight" inputmode="decimal" placeholder="ex.: 12.5"></div>
        <div><label>Idade (meses) (opcional)</label><input id="age_m" inputmode="numeric" placeholder="ex.: 18"></div>
      </div>

      <div class="row">
        <div><label>FiO₂ (0–1)</label><input id="fio2" inputmode="decimal" placeholder="ex.: 0.60"></div>
        <div><label>SpO₂ (%)</label><input id="spo2" inputmode="decimal" placeholder="ex.: 90"></div>
      </div>

      <div class="row">
        <div><label>PaO₂ (mmHg) (opcional)</label><input id="pao2" inputmode="decimal" placeholder="ex.: 55"></div>
        <div><label>PaCO₂ (mmHg) (opcional)</label><input id="paco2" inputmode="decimal" placeholder="ex.: 60"></div>
      </div>

      <div class="row">
        <div><label>MAP/PAM (mmHg)</label><input id="map" inputmode="decimal" placeholder="ex.: 55"></div>
        <div>
          <label>Vasoactivos em escalada?</label>
          <select id="vaso">
            <option value="no">não</option>
            <option value="yes">sim</option>
          </select>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div>
          <label>Modo ventilatório</label>
          <select id="vent_mode">
            <option>PC</option><option>VC</option><option>PRVC</option><option>SIMV</option><option>Outro</option>
          </select>
        </div>
        <div><label>PEEP actual (cmH₂O)</label><input id="peep" inputmode="decimal" placeholder="ex.: 8"></div>
      </div>

      <div class="row">
        <div><label>Pplat (cmH₂O) (se disponível)</label><input id="pplat" inputmode="decimal" placeholder="ex.: 24"></div>
        <div><label>PIP (cmH₂O) (opcional)</label><input id="pip" inputmode="decimal" placeholder="ex.: 30"></div>
      </div>

      <div class="row">
        <div><label>Vt (mL/kg) (opcional)</label><input id="vt_mlkg" inputmode="decimal" placeholder="ex.: 6"></div>
        <div>
          <label>Tendência de complacência com ↑PEEP</label>
          <select id="compliance_hint">
            <option value="unknown">desconhecida</option>
            <option value="improves">melhora</option>
            <option value="worsens">piora</option>
          </select>
        </div>
      </div>

      <div class="row" id="obstRow" style="display:none">
        <div>
          <label>Auto-PEEP provável/medida?</label>
          <select id="auto_peep">
            <option value="unknown">desconhecido</option>
            <option value="no">não</option>
            <option value="yes">sim</option>
          </select>
        </div>
        <div>
          <label>Broncoespasmo dominante?</label>
          <select id="bronchospasm">
            <option value="unknown">desconhecido</option>
            <option value="no">não</option>
            <option value="yes">sim</option>
          </select>
        </div>
      </div>

      <div class="hr"></div>

      <h2 style="margin:0 0 10px;font-size:14px">Segurança e validação</h2>

      <div class="row">
        <div>
          <label>Fuga aérea / pneumotórax não drenado?</label>
          <select id="air_leak">
            <option value="unknown">desconhecido</option>
            <option value="no">não</option>
            <option value="yes">sim</option>
          </select>
        </div>
        <div>
          <label>Sedação/sincronia adequada?</label>
          <select id="sedation">
            <option value="unknown">desconhecido</option>
            <option value="yes">sim</option>
            <option value="no">não</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Validação sénior (para “executável”)</label>
          <div class="cb">
            <input type="checkbox" id="senior_ok">
            <span class="small">Validado por mim (sénior responsável)</span>
          </div>
        </div>
        <div>
          <label>Protocolo/Notas locais (opcional)</label>
          <textarea id="local_protocol" placeholder="Cole notas do vosso protocolo institucional..."></textarea>
        </div>
      </div>

      <div class="hr"></div>

      <h2 style="margin:0 0 10px;font-size:14px">Parâmetros do ARM (opcional)</h2>
      <div class="small">
        Se deixares em branco, a app sugere (editável). Os alvos UCIP (DP≤15, Pplat≤28) são <b>soft</b>: avisam e ajustam risco, mas não proíbem.
      </div>

      <div class="row">
        <div><label>Step PEEP (cmH₂O)</label><input id="step_peep" inputmode="decimal" placeholder="vazio = sugerido"></div>
        <div><label>Tempo por step (seg)</label><input id="step_time" inputmode="numeric" placeholder="vazio = sugerido"></div>
      </div>
      <div class="row">
        <div><label>PEEP máximo (cmH₂O)</label><input id="peep_max" inputmode="decimal" placeholder="vazio = sugerido"></div>
        <div><label>Stop SpO₂ mínima (%)</label><input id="spo2_stop" inputmode="decimal" placeholder="vazio = sugerido"></div>
      </div>
      <div class="row">
        <div><label>Stop queda MAP (mmHg)</label><input id="map_drop_stop" inputmode="decimal" placeholder="vazio = sugerido"></div>
        <div><label>Stop Pplat (cmH₂O)</label><input id="pplat_stop" inputmode="decimal" placeholder="vazio = sugerido"></div>
      </div>

      <div class="actions">
        <button id="runBtn">Avaliar</button>
        <button id="fillRecruit">Exemplo Recrutável</button>
        <button id="fillObst">Exemplo Obstrutivo</button>
        <button id="clearBtn">Limpar</button>
      </div>

      <div class="small" style="margin-top:10px">
        Ferramenta educacional. A execução deve ser confirmada por protocolo institucional e responsável clínico.
      </div>
    </div>

    <!-- OUTPUT -->
    <div class="card">
      <h2 style="margin:0 0 10px;font-size:14px">Resultado</h2>

      <div class="box">
        <div class="pill">
          <span class="badge" id="statusBadge">—</span>
          <span class="mono" id="statusMeta">Sem avaliação</span>
        </div>
        <div class="hr"></div>
        <div class="small" id="statusSummary">Preenche e carrega em <span class="mono">Avaliar</span>.</div>
      </div>

      <div class="hr"></div>

      <div class="tabs">
        <button class="tabbtn active" data-tab="tabCalc">Cálculo</button>
        <button class="tabbtn" data-tab="tabManual">Manual</button>
        <button class="tabbtn" data-tab="tabFlow">Fluxograma</button>
      </div>

      <div class="tab active" id="tabCalc">
        <div class="hr"></div>
        <h2 style="margin:0 0 10px;font-size:14px">Regras activadas (audit trail)</h2>
        <div id="rulesOut" class="small">—</div>

        <div class="hr"></div>
        <h2 style="margin:0 0 10px;font-size:14px">Métricas</h2>
        <div class="box small" id="metricsOut">—</div>

        <div class="hr"></div>
        <h2 style="margin:0 0 10px;font-size:14px">Sugestão de protocolo</h2>
        <div id="protocolOut" class="small">—</div>

        <div class="hr"></div>
        <h2 style="margin:0 0 10px;font-size:14px">Mini-gráfico (sequência PEEP)</h2>
        <canvas id="chart" width="900" height="260"></canvas>
        <div class="small" style="margin-top:6px">Só visualização da sequência sugerida/definida.</div>

        <div class="hr"></div>
        <h2 style="margin:0 0 10px;font-size:14px">Titulação decremental (PEEP óptima)</h2>
        <div class="small">
          Decremental: <b>2 cmH₂O</b> a cada <b>60 s</b> (ou o vosso timing).<br>
          Critério: <b>menor DP</b> (primário) + <b>menor FiO₂</b> (secundário) + <b>melhor SpO₂</b> (terciário).
        </div>
        <div class="actions">
          <button id="decrPlanBtn">Gerar plano decremental</button>
          <button id="decrBestBtn">Calcular PEEP óptima</button>
          <button id="decrClearBtn">Limpar decremental</button>
        </div>
        <div id="decrOut" class="small" style="margin-top:10px">—</div>
      </div>

      <div class="tab" id="tabManual">
        <div class="hr"></div>
        <h2 style="margin:0 0 10px;font-size:14px">Guia passo-a-passo</h2>
        <div id="manualOut" class="small">—</div>

        <div class="hr"></div>
        <h2 style="margin:0 0 10px;font-size:14px">Checklist</h2>
        <div id="checkOut" class="small">—</div>
      </div>

      <div class="tab" id="tabFlow">
        <div class="hr"></div>
        <h2 style="margin:0 0 10px;font-size:14px">Fluxograma</h2>
        <div id="flowOut" class="small">—</div>
      </div>

      <div class="hr"></div>

      <h2 style="margin:0 0 10px;font-size:14px">Registo</h2>
      <textarea id="noteOut" readonly placeholder="Após avaliar, aparece um registo estruturado..."></textarea>

      <div class="actions">
        <button id="copyBtn">Copiar registo</button>
        <button id="pdfBtn">Gerar PDF</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ========= TABS ========= */
document.querySelectorAll(".tabbtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tabbtn").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
  });
});

/* ========= HELPERS ========= */
const $ = (id)=>document.getElementById(id);
function n(v){
  if(v===null || v===undefined) return null;
  const s = String(v).trim().replace(",",".");
  if(!s) return null;
  const x = Number(s);
  return Number.isFinite(x) ? x : null;
}
function esc(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}
function showMode(){
  $("obstRow").style.display = ($("mode").value==="obstructive") ? "grid" : "none";
}
$("mode").addEventListener("change", showMode);
showMode();

/* ========= UCIP: ALVOS SOFT ========= */
const UCIP_PPLAT_TARGET = 28;   // alvo (soft)
const UCIP_DP_TARGET = 15;      // alvo (soft)
const PPLAT_SOFT_HIGH = 32;     // risco sobe mais acima daqui
const DP_SOFT_HIGH = 18;

/* ========= PRESETS ========= */
function getPreset(){
  const p = $("preset").value;
  let base = { step_peep:2, step_time:60, peep_max:16, spo2_stop:85, map_drop_stop:10, pplat_stop:34 };
  if(p==="ards") base = { step_peep:2, step_time:60, peep_max:18, spo2_stop:82, map_drop_stop:10, pplat_stop:34 };
  if(p==="hemo_fragile") base = { step_peep:2, step_time:60, peep_max:14, spo2_stop:85, map_drop_stop:8, pplat_stop:32 };
  return base;
}

/* ========= DATA ========= */
function collect(){
  return {
    mode: $("mode").value,
    preset: $("preset").value,
    dx: $("dx").value.trim(),
    goal: $("goal").value.trim(),
    weight: n($("weight").value),
    age_m: n($("age_m").value),
    fio2: n($("fio2").value),
    spo2: n($("spo2").value),
    pao2: n($("pao2").value),
    paco2: n($("paco2").value),
    map: n($("map").value),
    vaso: $("vaso").value,
    vent_mode: $("vent_mode").value,
    peep: n($("peep").value),
    pplat: n($("pplat").value),
    pip: n($("pip").value),
    vt_mlkg: n($("vt_mlkg").value),
    compliance_hint: $("compliance_hint").value,
    auto_peep: $("auto_peep").value,
    bronchospasm: $("bronchospasm").value,
    air_leak: $("air_leak").value,
    sedation: $("sedation").value,
    senior_ok: $("senior_ok").checked,
    local_protocol: $("local_protocol").value.trim(),
    // optional overrides
    step_peep: n($("step_peep").value),
    step_time: n($("step_time").value),
    peep_max: n($("peep_max").value),
    spo2_stop: n($("spo2_stop").value),
    map_drop_stop: n($("map_drop_stop").value),
    pplat_stop: n($("pplat_stop").value),
  };
}
function derive(d){
  const out = {...d};
  out.dp = (d.pplat!=null && d.peep!=null) ? (d.pplat - d.peep) : null;
  out.pf = (d.pao2!=null && d.fio2!=null && d.fio2>0) ? (d.pao2/d.fio2) : null;
  return out;
}

/* ========= RULES ========= */
function addRule(arr, level, title, detail){
  arr.push({level, title, detail});
}
function renderRules(arr){
  if(!arr.length) return "—";
  const order = {bad:0,warn:1,info:2,ok:3};
  arr.sort((a,b)=>(order[a.level]??9)-(order[b.level]??9));
  return arr.map(r=>{
    const cls = r.level==="bad"?"bad":(r.level==="warn"?"warn":"good");
    const det = r.detail ? `<div class="small" style="margin-top:4px">${esc(r.detail)}</div>` : "";
    return `<div class="tag"><b class="${cls}">${r.level.toUpperCase()}</b> ${esc(r.title)}</div>${det}`;
  }).join("");
}

/* ========= PROTOCOLO SUGERIDO (RECRUTÁVEL) ========= */
function suggestRecruitableProtocol(d){
  const preset = getPreset();
  const p = {
    step_peep: d.step_peep ?? preset.step_peep,
    step_time: d.step_time ?? preset.step_time,
    peep_max: d.peep_max ?? preset.peep_max,
    spo2_stop: d.spo2_stop ?? preset.spo2_stop,
    map_drop_stop: d.map_drop_stop ?? preset.map_drop_stop,
    pplat_stop: d.pplat_stop ?? preset.pplat_stop,
  };

  if(d.vaso==="yes") p.peep_max = Math.min(p.peep_max, 14);
  if(d.age_m!=null && d.age_m < 6) p.peep_max = Math.min(p.peep_max, 14);
  if(d.compliance_hint==="worsens") p.peep_max = Math.min(p.peep_max, 14);

  if(p.pplat_stop==null) p.pplat_stop = 34;
  return p;
}

function buildSteps(peep0, step, peepMax){
  if(peep0==null || step==null || peepMax==null) return [];
  const out = [];
  let current = peep0;
  let i=1;
  while(current + step <= peepMax + 1e-9){
    current = current + step;
    out.push({i, peep: current});
    i++;
    if(i>24) break;
  }
  return out;
}

/* ========= EVAL (DP/PPLAT SOFT) ========= */
function evaluate(d){
  const rules = [];
  let benefit=0, risk=0;

  if(d.fio2==null || d.spo2==null) addRule(rules,"warn","Oxigenação incompleta","FiO₂ e SpO₂ recomendados.");
  if(d.map==null) addRule(rules,"warn","MAP não preenchida","Avaliação hemodinâmica recomendada.");
  if(d.peep==null) addRule(rules,"warn","PEEP não preenchida","Sem PEEP actual não há sequência stepwise.");

  if(d.air_leak==="yes"){
    addRule(rules,"bad","Hard stop: fuga aérea/pneumotórax não drenado","Evitar ARM/pressões elevadas até resolver/excluir.");
    risk += 10;
  }

  if(d.sedation==="no"){ addRule(rules,"warn","Sedação/sincronia inadequada","Optimizar antes/durante ARM."); risk += 1; }
  if(d.vaso==="yes"){ addRule(rules,"warn","Vasoactivos em escalada","Risco hemodinâmico com ↑pressão intratorácica."); risk += 2; }

  if(d.dp!=null){
    addRule(rules,"info","Driving pressure",`DP=${d.dp.toFixed(1)} cmH₂O (alvo UCIP ≤ ${UCIP_DP_TARGET}).`);
    if(d.dp > UCIP_DP_TARGET && d.dp <= DP_SOFT_HIGH){ addRule(rules,"warn","DP acima do alvo (soft)","Permitido; risco ↑. Ajustar ventilação e vigiar."); risk += 1; }
    else if(d.dp > DP_SOFT_HIGH){ addRule(rules,"warn","DP muito elevado (soft high)","Permitido; risco ↑↑. Limitar escalada e reavaliar estratégia."); risk += 2; }
    else { benefit += 1; }
  } else addRule(rules,"info","DP indisponível","Precisas de Pplat e PEEP para DP.");

  if(d.pplat!=null){
    addRule(rules,"info","Plateau",`Pplat=${d.pplat.toFixed(1)} (alvo UCIP ≤ ${UCIP_PPLAT_TARGET}).`);
    if(d.pplat > UCIP_PPLAT_TARGET && d.pplat <= PPLAT_SOFT_HIGH){ addRule(rules,"warn","Pplat acima do alvo (soft)","Permitido; risco ↑. Evitar aumentos desnecessários e vigiar."); risk += 1; }
    else if(d.pplat > PPLAT_SOFT_HIGH){ addRule(rules,"warn","Pplat muito elevado (soft high)","Permitido; risco ↑↑. Evitar aumentar ainda mais; reavaliar."); risk += 2; }
  }

  if(d.mode==="recruitable"){
    if(d.compliance_hint==="improves"){ addRule(rules,"info","Recrutabilidade provável","Complacência melhora com ↑PEEP."); benefit += 2; }
    if(d.compliance_hint==="worsens"){ addRule(rules,"warn","Possível não-recrutável/hiperinsuflação","Complacência piora com ↑PEEP."); risk += 1; }
    if(d.spo2!=null && d.fio2!=null && d.spo2<90 && d.fio2>=0.6){ addRule(rules,"info","Hipoxemia com FiO₂ alta","Potencial benefício de optimização/recrutamento."); benefit += 2; }
  }

  if(d.mode==="obstructive"){
    addRule(rules,"info","Modo obstrutivo","Não sugerir ARM clássica; guia anti-auto-PEEP/hiperinsuflação.");
    if(d.auto_peep==="yes"){ addRule(rules,"warn","Auto-PEEP provável","Evitar escalada de PEEP/pressões."); risk += 2; }
    if(d.bronchospasm==="yes"){ addRule(rules,"warn","Broncoespasmo dominante","Garantir tempo expiratório; evitar empilhamento."); risk += 1; }
  }

  const hardStop = rules.some(r=>r.level==="bad");
  const score = benefit - risk;

  let cls="warn", status="Cautela";
  if(hardStop){ cls="bad"; status="NÃO RECOMENDADO (hard stop)"; }
  else if(d.mode==="obstructive"){ cls = (risk>=3) ? "warn" : "good"; status = "Sem ARM clássica (guia obstrutivo)"; }
  else { if(score>=2){ cls="good"; status="ARM possível (benefício provável)"; } else if(score<=-2){ cls="warn"; status="ARM de benefício duvidoso (risco/benefício)"; } else { cls="warn"; status="Cautela (optimizar/mais dados)"; } }

  return {rules, benefit, risk, score, hardStop, cls, status};
}

/* ========= OUTPUT BUILDERS ========= */
function buildMetrics(d, ev){
  const lines = [];
  lines.push(`Modo: ${d.mode==="recruitable"?"Recrutável":"Obstrutivo"} | Preset: ${d.preset}`);
  if(d.dp!=null) lines.push(`DP: ${d.dp.toFixed(1)} (alvo ≤ ${UCIP_DP_TARGET}, soft)`);
  if(d.pplat!=null) lines.push(`Pplat: ${d.pplat.toFixed(1)} (alvo ≤ ${UCIP_PPLAT_TARGET}, soft)`);
  if(d.pf!=null) lines.push(`P/F: ${Math.round(d.pf)} (PaO₂/FiO₂)`);
  if(d.fio2!=null && d.spo2!=null) lines.push(`FiO₂: ${d.fio2} | SpO₂: ${d.spo2}%`);
  if(d.map!=null) lines.push(`MAP: ${d.map} | Vaso: ${d.vaso}`);
  lines.push(`Score: ${ev.score} (benef=${ev.benefit} | risco=${ev.risk})`);
  return `<div class="mono" style="white-space:pre-wrap">${esc(lines.join("\n"))}</div>`;
}

function buildProtocol(d, ev){
  if(d.mode==="obstructive"){
    return `<div class="warnbox"><b class="warn">Obstrutivo</b>: não é indicado protocolo de recrutamento alveolar clássico. Ver Manual/Fluxograma.</div>`;
  }

  const gate =
    ev.hardStop ? `<div class="badbox"><b class="bad">Hard stop</b>: não executar ARM enquanto não resolver/excluir fuga aérea/pneumotórax.</div>` :
    (d.senior_ok ? `<div class="okbox"><b class="good">Validado por sénior</b>: guia executável (sob protocolo institucional).</div>` :
                   `<div class="warnbox"><b class="warn">Sem validação sénior</b>: guia educativo (a execução depende de ti).</div>`);

  if(d.peep==null){
    return `${gate}<div class="warnbox"><b class="warn">Falta PEEP actual</b>: sem PEEP actual não há sequência stepwise.</div>`;
  }

  const p = suggestRecruitableProtocol(d);
  const steps = buildSteps(d.peep, p.step_peep, p.peep_max);

  const paramsLine =
    `Parâmetros sugeridos: step=${p.step_peep} | tempo=${p.step_time}s | PEEPmax=${p.peep_max} | stopSpO₂=${p.spo2_stop}% | stopMAPdrop=${p.map_drop_stop} | stopPplat=${p.pplat_stop} (operacional) | alvos soft: DP≤${UCIP_DP_TARGET}, Pplat≤${UCIP_PPLAT_TARGET}.`;

  const stop = `Parar se: SpO₂ < ${p.spo2_stop}% | queda MAP ≥ ${p.map_drop_stop} mmHg | Pplat ≥ ${p.pplat_stop} | ou intolerância clínica.`;

  const seq = steps.length ? `
    <ol class="list">
      ${steps.map(s=>`<li>PEEP → <span class="mono">${s.peep.toFixed(1)}</span> cmH₂O durante <span class="mono">${p.step_time}</span>s; reavaliar SpO₂/MAP/pressões/ventilação.</li>`).join("")}
      <li>Depois: titulação de PEEP de manutenção (menor PEEP que mantém ganho, idealmente aproximando DP/Pplat dos alvos).</li>
    </ol>` : `<div class="warnbox"><b class="warn">Sem sequência</b>: não foi possível gerar steps (ver step/PEEPmax).</div>`;

  const local = d.local_protocol ? `<div class="box" style="margin-top:10px"><b>Nota protocolo local</b><div class="small" style="margin-top:6px;white-space:pre-wrap">${esc(d.local_protocol)}</div></div>` : "";

  return `${gate}<div class="box"><div class="small">${esc(paramsLine)}</div><div class="small" style="margin-top:6px">${esc(stop)}</div>${seq}</div>${local}`;
}

function buildManual(d, ev){
  if(ev.hardStop){
    return `<div class="badbox"><b class="bad">Hard stop</b>: estabilizar/excluir fuga aérea/pneumotórax e reavaliar.</div>`;
  }

  if(d.mode==="obstructive"){
    const gate = d.senior_ok
      ? `<div class="okbox"><b class="good">Validado por sénior</b>: guia executável (sob protocolo).</div>`
      : `<div class="warnbox"><b class="warn">Sem validação sénior</b>: guia educativo.</div>`;
    return `${gate}
      <div class="box">
        <b>Obstrutivo (sem ARM clássica)</b>
        <ol class="list">
          <li>Excluir causas mecânicas (tubo/secreções/pneumotórax).</li>
          <li>Evitar empilhamento: garantir tempo expiratório; vigiar capnografia.</li>
          <li>Vigiar hemodinâmica: hiperinsuflação ↓ retorno venoso.</li>
          <li>PEEP externa: apenas se indicado e sob protocolo, com atenção a auto-PEEP.</li>
        </ol>
      </div>`;
  }

  const p = suggestRecruitableProtocol(d);
  const gate = d.senior_ok
    ? `<div class="okbox"><b class="good">Validado por sénior</b>: guia executável (sob protocolo).</div>`
    : `<div class="warnbox"><b class="warn">Sem validação sénior</b>: guia educativo.</div>`;

  return `${gate}
    <div class="box">
      <b>Antes</b>
      <ul class="list">
        <li>Definir indicação/objetivo; confirmar padrão recrutável.</li>
        <li>Monitorização: SpO₂ contínua, PA/MAP, EtCO₂, pressões; registar baseline.</li>
        <li>Optimizar sincronia (sedação/analgesia) conforme protocolo.</li>
        <li>Alvos soft UCIP: DP≤${UCIP_DP_TARGET} e Pplat≤${UCIP_PPLAT_TARGET} sempre que possível (não proíbem).</li>
        <li>Critérios de paragem (operacionais): SpO₂<${p.spo2_stop}%, MAP↓≥${p.map_drop_stop}, Pplat≥${p.pplat_stop} ou intolerância clínica.</li>
      </ul>
    </div>
    <div class="box" style="margin-top:10px">
      <b>Durante (stepwise)</b>
      <ul class="list">
        <li>Subir PEEP em steps; manter ${p.step_time}s por step; reavaliar a cada step.</li>
        <li>Se piora hemodinâmica/mecânica, reverter e reavaliar.</li>
      </ul>
    </div>
    <div class="box" style="margin-top:10px">
      <b>Depois</b>
      <ul class="list">
        <li>Titular PEEP de manutenção; tentar regressar aos alvos soft (DP/Pplat) se clinicamente possível.</li>
        <li>Reavaliar 5–15 min e documentar resposta.</li>
      </ul>
    </div>`;
}

function buildChecklist(){
  const items = [
    "Indicação/objetivo definido e comunicado.",
    "Monitorização pronta: SpO₂, PA/MAP, EtCO₂; alarmes adequados.",
    "Risco de fuga aérea/pneumotórax avaliado; plano de resposta.",
    "Sedação/sincronia optimizadas (conforme protocolo).",
    "Critérios de paragem definidos antes de iniciar.",
    "Documentar baseline, passos e resposta.",
    `Alvos soft UCIP: Pplat ≤ ${UCIP_PPLAT_TARGET} e DP ≤ ${UCIP_DP_TARGET} (sempre que possível).`
  ];
  return `<ul class="list">${items.map(x=>`<li>${esc(x)}</li>`).join("")}</ul>`;
}

function buildFlow(d, ev){
  const b = (t, s)=>`<div class="box" style="margin-bottom:10px"><b>${esc(t)}</b><div class="small" style="margin-top:6px">${s}</div></div>`;
  if(d.mode==="obstructive"){
    return b("1) Obstrutivo", "Sem ARM clássica → seguir guia obstrutivo.")
      + b("2) Hard stop?", ev.hardStop ? "<span class='bad'>Sim</span> → estabilizar/excluir fuga aérea/pneumotórax." : "Não detectado.")
      + b("3) Estratégia", "Evitar empilhamento/auto-PEEP; vigiar hemodinâmica; PEEP externa só sob protocolo.")
      + b("4) Validação", d.senior_ok ? "<span class='good'>Sénior OK</span>" : "<span class='warn'>Sem validação</span>");
  }
  return b("1) Suspeita recrutável", "Hipoxemia relevante e mecânica compatível; complacência melhora com ↑PEEP ajuda.")
    + b("2) Hard stop?", ev.hardStop ? "<span class='bad'>Sim</span> → não executar ARM." : "Não detectado.")
    + b("3) Alvos UCIP (soft)", `Tentar manter Pplat ≤ ${UCIP_PPLAT_TARGET} e DP ≤ ${UCIP_DP_TARGET} (não proíbe).`)
    + b("4) Protocolo stepwise", "Gerar steps + critérios de paragem + titulação de PEEP manutenção.")
    + b("5) Validação", d.senior_ok ? "<span class='good'>Sénior OK</span>" : "<span class='warn'>Sem validação</span>");
}

/* ========= CHART ========= */
function drawChart(steps, peep0){
  const c = $("chart");
  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);

  const pad=34, w=c.width, h=c.height;
  ctx.strokeStyle="rgba(230,240,255,0.22)";
  ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(pad,pad); ctx.lineTo(pad,h-pad); ctx.lineTo(w-pad,h-pad); ctx.stroke();
  ctx.fillStyle="rgba(231,238,252,0.85)"; ctx.font="14px system-ui"; ctx.fillText("Sequência PEEP", pad, 20);

  if(!steps.length || peep0==null){
    ctx.fillStyle="rgba(138,160,194,0.9)"; ctx.font="12px system-ui";
    ctx.fillText("Sem sequência (faltam parâmetros/PEEP ou modo obstrutivo).", pad, pad+18);
    return;
  }

  const values=[peep0, ...steps.map(s=>s.peep)];
  const minV=Math.min(...values), maxV=Math.max(...values);
  const yMin=minV-1, yMax=maxV+1;

  const x0=pad, x1=w-pad, y0=h-pad, y1=pad;
  const xAt=i=>x0+(x1-x0)*(i/(values.length-1));
  const yAt=v=>y0-(y0-y1)*((v-yMin)/(yMax-yMin || 1));

  ctx.strokeStyle="rgba(231,238,252,0.75)";
  ctx.lineWidth=2;
  ctx.beginPath();
  values.forEach((v,i)=>{const x=xAt(i), y=yAt(v); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);});
  ctx.stroke();

  ctx.fillStyle="rgba(231,238,252,0.85)";
  ctx.font="11px ui-monospace, Menlo, Consolas";
  values.forEach((v,i)=>{const x=xAt(i), y=yAt(v); ctx.beginPath(); ctx.arc(x,y,3.2,0,Math.PI*2); ctx.fill(); ctx.fillText(String(Math.round(v*10)/10), x-8, y-10);});
}

/* ========= DECREMENTAL ========= */
const DECR = { active:false, plan:[], best:null };
function decrReset(){ DECR.active=false; DECR.plan=[]; DECR.best=null; if($("decrOut")) $("decrOut").innerHTML="—"; }
function decrGuard(){
  if(!LAST.d || !LAST.ev) return {ok:false, msg:"Executa primeiro: Avaliar."};
  if(LAST.d.mode!=="recruitable") return {ok:false, msg:"Modo obstrutivo: não aplicável."};
  if(LAST.ev.hardStop) return {ok:false, msg:"Hard stop activo: não iniciar decremental."};
  if(LAST.d.peep==null) return {ok:false, msg:"Falta PEEP actual."};
  if(!LAST.p) return {ok:false, msg:"Sem parâmetros (faz Avaliar com modo recrutável)."};
  return {ok:true, msg:"ok"};
}
function genDecrPlan(){
  const step=2;
  const start = (LAST.p && Number.isFinite(LAST.p.peep_max)) ? LAST.p.peep_max : LAST.d.peep;
  const end = LAST.d.peep;
  const plan=[];
  if(start==null || end==null) return plan;
  let cur = start;
  let i=1;
  while(cur >= end - 1e-9){
    plan.push({i, peep:Number(cur.toFixed(1)), dp:null, fio2:null, spo2:null});
    cur -= step;
    i++;
    if(i>30) break;
  }
  return plan;
}
function renderDecrTable(){
  if(!DECR.plan.length){
    $("decrOut").innerHTML=`<div class="warnbox"><b class="warn">Sem plano</b>: gera o plano decremental primeiro.</div>`;
    return;
  }
  let html = `
    <div class="box" style="margin-bottom:10px">
      <b>Plano decremental</b>
      <div class="small" style="margin-top:6px">
        Preenche DP, FiO₂ e SpO₂ em cada step (após ~60s). Depois carrega em “Calcular PEEP óptima”.
      </div>
    </div>
    <table id="decrTable">
      <thead>
        <tr><th>Step</th><th>PEEP</th><th>DP</th><th>FiO₂</th><th>SpO₂</th></tr>
      </thead>
      <tbody>
  `;
  html += DECR.plan.map((r, idx)=>`
    <tr data-idx="${idx}">
      <td class="mono">${r.i}</td>
      <td class="mono">${r.peep.toFixed(1)}</td>
      <td><input inputmode="decimal" data-field="dp" value="${r.dp??""}" placeholder="ex.: 14"></td>
      <td><input inputmode="decimal" data-field="fio2" value="${r.fio2??""}" placeholder="ex.: 0.45"></td>
      <td><input inputmode="decimal" data-field="spo2" value="${r.spo2??""}" placeholder="ex.: 93"></td>
    </tr>
  `).join("");
  html += `</tbody></table><div id="decrBestBox" style="margin-top:10px">—</div>`;
  $("decrOut").innerHTML = html;

  $("decrTable").querySelectorAll("input").forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const idx = Number(inp.closest("tr").dataset.idx);
      const f = inp.dataset.field;
      DECR.plan[idx][f] = n(inp.value);
      DECR.best=null;
      const b=$("decrBestBox"); if(b) b.innerHTML="—";
      inp.closest("tbody").querySelectorAll("tr").forEach(x=>x.classList.remove("rowbest"));
    });
  });
}
function computeDecrBest(){
  const rows = DECR.plan.map((r, idx)=>({...r, idx}))
    .filter(r=>Number.isFinite(r.dp) && Number.isFinite(r.fio2) && Number.isFinite(r.spo2));
  if(!rows.length) return null;

  let best = rows[0];
  for(const r of rows.slice(1)){
    if(r.dp < best.dp) best=r;
    else if(r.dp === best.dp && r.fio2 < best.fio2) best=r;
    else if(r.dp === best.dp && r.fio2 === best.fio2 && r.spo2 > best.spo2) best=r;
  }
  return best;
}
function renderDecrBest(best){
  const tbody = $("decrTable")?.querySelector("tbody");
  if(tbody){
    tbody.querySelectorAll("tr").forEach(x=>x.classList.remove("rowbest"));
    const tr = tbody.querySelector(`tr[data-idx="${best.idx}"]`);
    if(tr) tr.classList.add("rowbest");
  }
  $("decrBestBox").innerHTML = `
    <div class="okbox">
      <b class="good">PEEP óptima sugerida: ${best.peep.toFixed(1)} cmH₂O</b><br>
      <span class="mono">DP ${best.dp.toFixed(1)} | FiO₂ ${best.fio2.toFixed(2)} | SpO₂ ${best.spo2.toFixed(0)}%</span><br>
      <div class="small" style="margin-top:6px">
        Critério: menor DP → menor FiO₂ → melhor SpO₂. Validação clínica obrigatória.
      </div>
    </div>
  `;
}
function decrAppendToNote(note){
  if(!DECR.best) return note;
  const b=DECR.best;
  return note + `

FASE DECREMENTAL (2 cmH₂O / ~60 s; critério: menor DP + menor FiO₂ + melhor SpO₂)
- PEEP óptima sugerida: ${b.peep.toFixed(1)} cmH₂O
- DP: ${b.dp.toFixed(1)} | FiO₂: ${b.fio2.toFixed(2)} | SpO₂: ${b.spo2.toFixed(0)}%
`;
}

/* ========= NOTE / COPY / PDF ========= */
function buildNote(d, ev, p, steps){
  const now=new Date().toISOString().slice(0,19).replace("T"," ");
  const fired = ev.rules.map(r=>`- [${r.level.toUpperCase()}] ${r.title}${r.detail ? " — "+r.detail : ""}`).join("\n");
  const seq = (steps && steps.length) ? steps.map(s=>`- PEEP ${s.peep.toFixed(1)} por ${p.step_time}s`).join("\n") : "—";

  let base = `Pulmoniq — Pediatric ARM (educacional) | ${now}
Modo: ${d.mode==="recruitable"?"Recrutável":"Obstrutivo"} | Preset: ${d.preset} | Sénior: ${d.senior_ok?"SIM":"NÃO"}
Dx/Objetivo: ${d.dx||"—"} | ${d.goal||"—"}

Dados:
- Peso ${d.weight ?? "—"} kg | Idade ${d.age_m ?? "—"} meses
- FiO2 ${d.fio2 ?? "—"} | SpO2 ${d.spo2 ?? "—"}% | PaO2 ${d.pao2 ?? "—"} | P/F ${d.pf!=null?Math.round(d.pf):"—"}
- MAP ${d.map ?? "—"} | Vaso ${d.vaso}
- Vent ${d.vent_mode} | PEEP ${d.peep ?? "—"} | Pplat ${d.pplat ?? "—"} | DP ${d.dp!=null?d.dp.toFixed(1):"—"}

Alvos soft UCIP: Pplat ≤ ${UCIP_PPLAT_TARGET} | DP ≤ ${UCIP_DP_TARGET}

Resultado: ${ev.status}

Regras:
${fired || "—"}

Protocolo:
${(d.mode==="recruitable" && !ev.hardStop && d.peep!=null) ? (
`Params: step=${p.step_peep} | tempo=${p.step_time}s | PEEPmax=${p.peep_max} | stopSpO2=${p.spo2_stop}% | stopMAPdrop=${p.map_drop_stop} | stopPplat=${p.pplat_stop}
Sequência:
${seq}`
) : "Sem ARM clássica / ou hard stop / ou falta PEEP."}

Notas locais:
${d.local_protocol || "—"}
`;
  return decrAppendToNote(base);
}

$("copyBtn").addEventListener("click", async ()=>{
  try{
    await navigator.clipboard.writeText($("noteOut").value || "");
    $("copyBtn").textContent="Copiado ✓";
    setTimeout(()=>$("copyBtn").textContent="Copiar registo", 1200);
  }catch(e){
    alert("Falhou a cópia automática. Copia manualmente.");
  }
});
$("pdfBtn").addEventListener("click", ()=>{ window.print(); });

/* ========= MAIN RUN ========= */
const LAST = { d:null, ev:null, p:null, steps:[] };

function renderStatus(d, ev){
  $("statusBadge").textContent = ev.status;
  $("statusBadge").className = "badge " + ev.cls;

  const meta=[];
  if(d.dp!=null) meta.push(`DP ${d.dp.toFixed(1)}`);
  if(d.pplat!=null) meta.push(`Pplat ${d.pplat.toFixed(0)}`);
  if(d.peep!=null) meta.push(`PEEP ${d.peep.toFixed(0)}`);
  if(d.map!=null) meta.push(`MAP ${d.map.toFixed(0)}`);
  meta.push(d.senior_ok ? "Sénior: OK" : "Sénior: NÃO");
  $("statusMeta").textContent = meta.join(" · ");

  $("statusSummary").textContent =
    d.mode==="recruitable"
    ? "Recrutável: cálculo + sugestão stepwise + manual + fluxograma."
    : "Obstrutivo: não sugere ARM clássica; guia estruturado.";
}

function run(){
  const d = derive(collect());
  const ev = evaluate(d);

  LAST.d=d; LAST.ev=ev; LAST.p=null; LAST.steps=[];

  $("rulesOut").innerHTML = renderRules(ev.rules);
  $("metricsOut").innerHTML = buildMetrics(d, ev);
  $("manualOut").innerHTML = buildManual(d, ev);
  $("checkOut").innerHTML = buildChecklist();
  $("flowOut").innerHTML = buildFlow(d, ev);

  let p=null, steps=[];
  if(d.mode==="recruitable" && !ev.hardStop && d.peep!=null){
    p = suggestRecruitableProtocol(d);
    steps = buildSteps(d.peep, p.step_peep, p.peep_max);
    LAST.p=p; LAST.steps=steps;
  }

  $("protocolOut").innerHTML = buildProtocol(d, ev);
  drawChart(steps, d.peep);

  if(d.mode!=="recruitable" || ev.hardStop) decrReset();

  $("noteOut").value = buildNote(
    d, ev,
    p || {step_peep:"—",step_time:"—",peep_max:"—",spo2_stop:"—",map_drop_stop:"—",pplat_stop:"—"},
    steps
  );

  renderStatus(d, ev);
}
$("runBtn").addEventListener("click", run);

/* ========= DECR EVENTS ========= */
$("decrPlanBtn").addEventListener("click", ()=>{
  const g = decrGuard();
  if(!g.ok){ $("decrOut").innerHTML = `<div class="warnbox"><b class="warn">Não disponível</b>: ${esc(g.msg)}</div>`; return; }
  DECR.active=true; DECR.best=null; DECR.plan = genDecrPlan();
  renderDecrTable();
});
$("decrBestBtn").addEventListener("click", ()=>{
  const g = decrGuard();
  if(!g.ok){ $("decrOut").innerHTML = `<div class="warnbox"><b class="warn">Não disponível</b>: ${esc(g.msg)}</div>`; return; }
  if(!DECR.active || !DECR.plan.length){ $("decrOut").innerHTML = `<div class="warnbox"><b class="warn">Sem plano</b>: gera primeiro o plano decremental.</div>`; return; }
  const best = computeDecrBest();
  if(!best){ const box=document.getElementById("decrBestBox"); if(box) box.innerHTML=`<div class="warnbox"><b class="warn">Dados insuficientes</b>: preenche DP, FiO₂ e SpO₂ em ≥1 step.</div>`; return; }
  DECR.best=best; renderDecrBest(best);
  const p = LAST.p || {step_peep:"—",step_time:"—",peep_max:"—",spo2_stop:"—",map_drop_stop:"—",pplat_stop:"—"};
  $("noteOut").value = buildNote(LAST.d, LAST.ev, p, LAST.steps);
});
$("decrClearBtn").addEventListener("click", ()=>{
  decrReset();
  if(LAST.d && LAST.ev){
    const p = LAST.p || {step_peep:"—",step_time:"—",peep_max:"—",spo2_stop:"—",map_drop_stop:"—",pplat_stop:"—"};
    $("noteOut").value = buildNote(LAST.d, LAST.ev, p, LAST.steps);
  }
});

/* ========= BUTTONS ========= */
$("fillRecruit").addEventListener("click", ()=>{
  $("mode").value="recruitable"; showMode();
  $("preset").value="ucip_default";
  $("dx").value="ARDS / atelectasia (exemplo)";
  $("goal").value="Melhorar oxigenação mantendo DP/Pplat próximos dos alvos";
  $("weight").value="12"; $("age_m").value="24";
  $("fio2").value="0.70"; $("spo2").value="88";
  $("pao2").value="55"; $("paco2").value="60";
  $("map").value="55"; $("vaso").value="no";
  $("vent_mode").value="PC";
  $("peep").value="8"; $("pplat").value="30"; $("pip").value="34"; $("vt_mlkg").value="6";
  $("compliance_hint").value="improves";
  $("air_leak").value="no"; $("sedation").value="yes";
  $("senior_ok").checked=true;
  $("step_peep").value=""; $("step_time").value=""; $("peep_max").value="";
  $("spo2_stop").value=""; $("map_drop_stop").value=""; $("pplat_stop").value="";
  decrReset();
  run();
});

$("fillObst").addEventListener("click", ()=>{
  $("mode").value="obstructive"; showMode();
  $("preset").value="ucip_default";
  $("dx").value="Asma grave (exemplo)";
  $("goal").value="Evitar hiperinsuflação/auto-PEEP";
  $("weight").value="18"; $("age_m").value="96";
  $("fio2").value="0.40"; $("spo2").value="92";
  $("map").value="60"; $("vaso").value="no";
  $("vent_mode").value="PC";
  $("peep").value="5"; $("pplat").value=""; $("pip").value="32"; $("vt_mlkg").value="";
  $("auto_peep").value="yes"; $("bronchospasm").value="yes";
  $("air_leak").value="unknown"; $("sedation").value="yes";
  $("senior_ok").checked=true;
  decrReset();
  run();
});

$("clearBtn").addEventListener("click", ()=>{
  [
    "dx","goal","weight","age_m","fio2","spo2","pao2","paco2","map","peep","pplat","pip","vt_mlkg",
    "local_protocol","step_peep","step_time","peep_max","spo2_stop","map_drop_stop","pplat_stop"
  ].forEach(id=>$(id).value="");
  ["vaso","vent_mode","compliance_hint","air_leak","sedation","auto_peep","bronchospasm","preset"].forEach(id=>$(id).selectedIndex=0);
  $("senior_ok").checked=false;
  $("mode").value="recruitable"; showMode();

  $("rulesOut").textContent="—";
  $("metricsOut").textContent="—";
  $("protocolOut").textContent="—";
  $("manualOut").textContent="—";
  $("checkOut").textContent="—";
  $("flowOut").textContent="—";
  $("noteOut").value="";
  $("statusBadge").textContent="—";
  $("statusBadge").className="badge";
  $("statusMeta").textContent="Sem avaliação";
  $("statusSummary").textContent="Preenche e carrega em Avaliar.";
  const ctx=$("chart").getContext("2d"); ctx.clearRect(0,0,$("chart").width,$("chart").height);
  decrReset();
});

/* ========= PWA SW ========= */
if("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}
</script>
</body>
</html>
