<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Pulmoniq — Pediatric ARM</title>
  <meta name="description" content="Pulmoniq — Pediatric ARM. Apoio à decisão (educacional) para recrutamento alveolar em pediatria, com modo recrutável e modo obstrutivo."/>
  <meta name="theme-color" content="#0b1220"/>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="assets/icon-192.png.PNG">
  <link rel="apple-touch-icon" href="assets/icon-192.png.PNG">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Pulmoniq">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --bg1:#071025; --bg2:#0b1220; --card: rgba(17,26,46,.92);
      --line:#263554; --text:#e7eefc; --muted:#8aa0c2; --chip:#172341; --btn:#1f2f52;
      --good:#34d399; --warn:#fbbf24; --bad:#fb7185;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);font-family:var(--sans)}
    .wrap{max-width:1220px;margin:0 auto;padding:18px}
    header{display:flex;align-items:center;gap:14px;margin-bottom:14px}
    header img{width:56px;height:56px;border-radius:14px;object-fit:cover;background:#0f172a;border:1px solid var(--line)}
    h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:13px;margin-top:2px;line-height:1.3}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
    .card h2{margin:0 0 10px;font-size:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:560px){.row{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input,select,textarea{
      width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);
      background:#0c162d;color:var(--text);outline:none
    }
    input::placeholder, textarea::placeholder{color:#6f86ab}
    textarea{min-height:90px;resize:vertical}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{background:var(--btn);border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
    button:hover{filter:brightness(1.07)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:7px 10px;border-radius:999px;border:1px solid var(--line);background:var(--chip);font-size:12px}
    .k{font-family:var(--mono);font-size:12px;color:#cfe2ff}
    .badge{font-weight:900}
    .good{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .small{font-size:12px;color:var(--muted);line-height:1.4}
    .mono{font-family:var(--mono)}
    .list{margin:8px 0 0 18px;color:#d9e6ff}
    .list li{margin:4px 0}
    .box{border:1px solid var(--line);background:#0b1732;border-radius:14px;padding:10px}
    .warnbox{border:1px solid rgba(251,191,36,.45);background:rgba(251,191,36,.08);border-radius:14px;padding:10px}
    .badbox{border:1px solid rgba(251,113,133,.55);background:rgba(251,113,133,.10);border-radius:14px;padding:10px}
    .okbox{border:1px solid rgba(52,211,153,.45);background:rgba(52,211,153,.08);border-radius:14px;padding:10px}
    .tag{display:inline-block;padding:5px 8px;border-radius:999px;border:1px solid var(--line);background:#0b1732;font-size:12px;margin:0 6px 6px 0}
    canvas{width:100%;height:220px;border-radius:14px;border:1px solid var(--line);background:#0b1732}

    /* Tabs */
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tabbtn{padding:8px 10px;border-radius:12px;border:1px solid var(--line);background:#0b1732;color:var(--text);cursor:pointer}
    .tabbtn.active{background:var(--btn)}
    .tab{display:none}
    .tab.active{display:block}
    .flowbox{border:1px dashed rgba(231,238,252,.25);border-radius:14px;padding:10px;background:rgba(11,23,50,.55)}
    .flowstep{margin:8px 0;padding:10px;border-radius:12px;border:1px solid var(--line);background:#0c162d}
    .flowarrow{color:rgba(231,238,252,.6);text-align:center;margin:6px 0}
    .cb{display:flex;gap:8px;align-items:center;margin-top:8px}
    .cb input{width:18px;height:18px}
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <img src="assets/logo.png.PNG" alt="Pulmoniq logo">
    <div>
      <h1>Pulmoniq</h1>
      <div class="sub">Pediatric ARM · Tabs: Cálculo / Manual / Fluxograma · Sugestão de protocolo (com validação sénior) · Audit trail · PDF</div>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT: INPUTS -->
    <div class="card">
      <h2>Dados</h2>

      <div class="row">
        <div>
          <label>Modo</label>
          <select id="mode">
            <option value="recruitable">Recrutável (ARDS / atelectasia) — ARM stepwise</option>
            <option value="obstructive">Obstrutivo (asma / bronquiolite) — sem ARM clássica</option>
          </select>
        </div>
        <div>
          <label>Preset</label>
          <select id="preset"></select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Diagnóstico / nota rápida</label>
          <input id="dx" placeholder="ex.: ARDS moderado; atelectasia pós-op; asma grave...">
        </div>
        <div>
          <label>Objectivo</label>
          <input id="goal" placeholder="ex.: melhorar oxigenação / reduzir DP / melhorar mecânica...">
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div><label>Peso (kg)</label><input id="weight" inputmode="decimal" placeholder="ex.: 12.5"></div>
        <div><label>Idade (meses) (opcional)</label><input id="age_m" inputmode="numeric" placeholder="ex.: 18"></div>
      </div>

      <div class="row">
        <div><label>FiO₂ (0–1)</label><input id="fio2" inputmode="decimal" placeholder="ex.: 0.60"></div>
        <div><label>SpO₂ (%)</label><input id="spo2" inputmode="decimal" placeholder="ex.: 90"></div>
      </div>

      <div class="row">
        <div><label>PaO₂ (mmHg) (opcional)</label><input id="pao2" inputmode="decimal" placeholder="ex.: 55"></div>
        <div><label>PaCO₂ (mmHg) (opcional)</label><input id="paco2" inputmode="decimal" placeholder="ex.: 60"></div>
      </div>

      <div class="row">
        <div><label>MAP/PAM (mmHg)</label><input id="map" inputmode="decimal" placeholder="ex.: 55"></div>
        <div>
          <label>Vasoactivos em escalada? (sim/não)</label>
          <select id="vaso"><option value="no">não</option><option value="yes">sim</option></select>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div>
          <label>Modo ventilatório</label>
          <select id="vent_mode">
            <option>PC</option><option>VC</option><option>PRVC</option><option>SIMV</option><option>Outro</option>
          </select>
        </div>
        <div><label>PEEP actual (cmH₂O)</label><input id="peep" inputmode="decimal" placeholder="ex.: 8"></div>
      </div>

      <div class="row">
        <div><label>Pplat (cmH₂O) (se disponível)</label><input id="pplat" inputmode="decimal" placeholder="ex.: 24"></div>
        <div><label>PIP (cmH₂O) (opcional)</label><input id="pip" inputmode="decimal" placeholder="ex.: 30"></div>
      </div>

      <div class="row">
        <div><label>Vt (mL/kg) (opcional)</label><input id="vt_mlkg" inputmode="decimal" placeholder="ex.: 6"></div>
        <div>
          <label>Complacência (tendência)</label>
          <select id="compliance_hint">
            <option value="unknown">desconhecido</option>
            <option value="improves_with_peep">melhora quando ↑ PEEP</option>
            <option value="worsens_with_peep">piora quando ↑ PEEP</option>
          </select>
        </div>
      </div>

      <div class="row" id="obstRow" style="display:none">
        <div>
          <label>Auto-PEEP?</label>
          <select id="auto_peep">
            <option value="unknown">desconhecido</option>
            <option value="no">não</option>
            <option value="yes">sim</option>
          </select>
        </div>
        <div>
          <label>Broncoespasmo dominante?</label>
          <select id="bronchospasm">
            <option value="unknown">desconhecido</option>
            <option value="no">não</option>
            <option value="yes">sim</option>
          </select>
        </div>
      </div>

      <div class="hr"></div>

      <h2>Segurança e validação</h2>
      <div class="row">
        <div>
          <label>Fuga aérea / pneumotórax não drenado?</label>
          <select id="air_leak">
            <option value="unknown">desconhecido</option>
            <option value="no">não</option>
            <option value="yes">sim</option>
          </select>
        </div>
        <div>
          <label>Sedação/sincronia adequadas?</label>
          <select id="sedation">
            <option value="unknown">desconhecido</option>
            <option value="no">não</option>
            <option value="yes">sim</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Validação sénior (obrigatório para “executável”)</label>
          <div class="cb">
            <input type="checkbox" id="senior_ok">
            <span class="small">Validado por mim (sénior responsável)</span>
          </div>
        </div>
        <div>
          <label>Notas locais (protocolo institucional)</label>
          <textarea id="local_protocol" placeholder="Cole aqui notas/protocolo local (opcional)."></textarea>
        </div>
      </div>

      <div class="hr"></div>

      <h2>Parâmetros (opcionais) — se não preencheres, o Pulmoniq sugere</h2>
      <div class="small">
        Em modo <span class="mono">Recrutável</span>, se deixares vazio, a app sugere stepwise (editável) com base nos dados.
        Em modo <span class="mono">Obstrutivo</span>, não gera ARM clássica.
      </div>

      <div class="row">
        <div><label>Step PEEP (cmH₂O)</label><input id="step_peep" inputmode="decimal" placeholder="vazio = sugestão"></div>
        <div><label>Tempo por step (seg)</label><input id="step_time" inputmode="numeric" placeholder="vazio = sugestão"></div>
      </div>
      <div class="row">
        <div><label>PEEP máximo (cmH₂O)</label><input id="peep_max" inputmode="decimal" placeholder="vazio = sugestão"></div>
        <div><label>Stop Pplat (cmH₂O)</label><input id="pplat_stop" inputmode="decimal" placeholder="vazio = sugestão"></div>
      </div>
      <div class="row">
        <div><label>Stop queda MAP (mmHg)</label><input id="map_drop_stop" inputmode="decimal" placeholder="vazio = sugestão"></div>
        <div><label>Stop SpO₂ mínima (%)</label><input id="spo2_stop" inputmode="decimal" placeholder="vazio = sugestão"></div>
      </div>

      <div class="actions">
        <button id="runBtn">Avaliar</button>
        <button id="fillRecruit">Exemplo Recrutável</button>
        <button id="fillObst">Exemplo Obstrutivo</button>
        <button id="clearBtn">Limpar</button>
      </div>

      <div class="small" style="margin-top:10px">
        Esta ferramenta é <b>apoio à decisão/educacional</b>. A execução deve seguir <b>protocolo institucional</b> e validação do sénior.
      </div>
    </div>

    <!-- RIGHT: OUTPUT + TABS -->
    <div class="card">
      <h2>Saída</h2>

      <div class="box">
        <div class="pill">
          <span class="badge" id="statusBadge">—</span>
          <span class="k" id="statusMeta">Sem avaliação</span>
        </div>
        <div class="hr"></div>
        <div class="small" id="statusSummary">Preenche e carrega em <span class="mono">Avaliar</span>.</div>
      </div>

      <div class="hr"></div>

      <div class="tabs">
        <button class="tabbtn active" data-tab="calcTab">Cálculo</button>
        <button class="tabbtn" data-tab="manualTab">Manual</button>
        <button class="tabbtn" data-tab="flowTab">Fluxograma</button>
      </div>

      <!-- TAB: CÁLCULO -->
      <div class="tab active" id="calcTab">
        <div class="hr"></div>
        <h2>Regras activadas (audit trail)</h2>
        <div id="rulesFired" class="small">—</div>

        <div class="hr"></div>
        <h2>Métricas</h2>
        <div class="box small" id="metricsOut">—</div>

        <div class="hr"></div>
        <h2>Sugestão de protocolo (parâmetros + passos)</h2>
        <div id="protocolOut" class="small">—</div>

        <div class="hr"></div>
        <h2>Mini-gráfico (sequência PEEP)</h2>
        <canvas id="peepChart" width="900" height="260"></canvas>
        <div class="small" style="margin-top:6px">Visualiza a sequência sugerida/definida.</div>
      </div>

      <!-- TAB: MANUAL -->
      <div class="tab" id="manualTab">
        <div class="hr"></div>
        <h2>Guia passo-a-passo</h2>
        <div id="guideOut" class="small">—</div>

        <div class="hr"></div>
        <h2>Checklist</h2>
        <div id="checklistOut" class="small">—</div>
      </div>

      <!-- TAB: FLUXOGRAMA -->
      <div class="tab" id="flowTab">
        <div class="hr"></div>
        <h2>Fluxograma (decisão)</h2>
        <div id="flowOut" class="small">—</div>
      </div>

      <div class="hr"></div>

      <h2>Registo</h2>
      <textarea id="noteOut" readonly placeholder="Aqui aparece o registo estruturado..."></textarea>
      <div class="actions">
        <button id="copyNote">Copiar registo</button>
        <button id="pdfBtn">Gerar PDF</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   Pulmoniq — Pediatric ARM
   Tabs + decisão + protocolo sugerido + manual + fluxograma
   NOTA: thresholds “default” são conservadores e editáveis (e devem alinhar com o vosso protocolo local).
========================= */

const $ = (id)=>document.getElementById(id);
const $$ = (q)=>document.querySelectorAll(q);

function numOrNull(v){
  if(v===undefined || v===null) return null;
  const s = String(v).trim().replace(",",".");
  if(!s || s==="—") return null;
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* --------- Tabs --------- */
$$(".tabbtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    $$(".tabbtn").forEach(b=>b.classList.remove("active"));
    $$(".tab").forEach(t=>t.classList.remove("active"));
    btn.classList.add("active");
    $(btn.dataset.tab).classList.add("active");
  });
});

/* --------- Mode UI --------- */
function showModeSpecific(){
  $("obstRow").style.display = ($("mode").value==="obstructive") ? "grid" : "none";
}
$("mode").addEventListener("change", ()=>{
  showModeSpecific();
  refreshPresetList();
  applyPreset();
});
showModeSpecific();

/* --------- Presets --------- */
const PRESETS = {
  recruitable: [
    { id:"ards_generic", name:"ARDS (genérico)", fill:{}, paramsHint:{} },
    { id:"atelectasis_postop", name:"Atelectasia pós-op", fill:{}, paramsHint:{} }
  ],
  obstructive: [
    { id:"asthma", name:"Asma grave", fill:{}, paramsHint:{} },
    { id:"bronchiolitis", name:"Bronquiolite", fill:{}, paramsHint:{} }
  ]
};

function refreshPresetList(){
  const mode = $("mode").value;
  const sel = $("preset");
  sel.innerHTML = "";
  PRESETS[mode].forEach(p=>{
    const opt=document.createElement("option");
    opt.value=p.id; opt.textContent=p.name;
    sel.appendChild(opt);
  });
}
refreshPresetList();
function applyPreset(){
  // aqui podes expandir com autofill futuro; por agora não mexe nos dados
}
$("preset").addEventListener("change", applyPreset);

/* --------- Data --------- */
function collect(){
  return {
    mode: $("mode").value,
    preset: $("preset").value,
    dx: $("dx").value.trim(),
    goal: $("goal").value.trim(),

    weight: numOrNull($("weight").value),
    age_m: numOrNull($("age_m").value),

    fio2: numOrNull($("fio2").value),
    spo2: numOrNull($("spo2").value),
    pao2: numOrNull($("pao2").value),
    paco2: numOrNull($("paco2").value),

    map: numOrNull($("map").value),
    vaso: $("vaso").value,

    vent_mode: $("vent_mode").value,
    peep: numOrNull($("peep").value),
    pplat: numOrNull($("pplat").value),
    pip: numOrNull($("pip").value),
    vt_mlkg: numOrNull($("vt_mlkg").value),
    compliance_hint: $("compliance_hint").value,

    auto_peep: $("auto_peep").value,
    bronchospasm: $("bronchospasm").value,

    air_leak: $("air_leak").value,
    sedation: $("sedation").value,
    senior_ok: $("senior_ok").checked,

    // protocol params (optional)
    step_peep: numOrNull($("step_peep").value),
    step_time: numOrNull($("step_time").value),
    peep_max: numOrNull($("peep_max").value),
    pplat_stop: numOrNull($("pplat_stop").value),
    map_drop_stop: numOrNull($("map_drop_stop").value),
    spo2_stop: numOrNull($("spo2_stop").value),

    local_protocol: $("local_protocol").value.trim()
  };
}

function derive(d){
  const out = {...d};
  out.dp = (d.pplat!=null && d.peep!=null) ? (d.pplat - d.peep) : null;
  // simple oxygenation index proxy if PaO2 available: P/F ratio
  out.pf = (d.pao2!=null && d.fio2!=null && d.fio2>0) ? (d.pao2 / d.fio2) : null;
  return out;
}

/* --------- Rules --------- */
function addRule(fired, level, title, detail){
  fired.push({level, title, detail});
}
function renderRules(fired){
  if(!fired.length) return "—";
  const order = {bad:0,warn:1,info:2,ok:3};
  fired.sort((a,b)=>(order[a.level]??9)-(order[b.level]??9));
  return fired.map(r=>{
    const c = r.level==="bad" ? "bad" : (r.level==="warn" ? "warn" : "good");
    const tag = r.level.toUpperCase();
    const det = r.detail ? `<div class="small" style="color:var(--muted);margin-top:4px">${escapeHtml(r.detail)}</div>` : "";
    return `<div class="tag"><b class="${c}">${tag}</b> ${escapeHtml(r.title)}</div>${det}`;
  }).join("");
}

/* --------- Protocol suggestion (Recrutável) ---------
   Objetivo: sugerir uma sequência stepwise + critérios de paragem.
   - Se o utilizador já preencheu parâmetros, respeita.
   - Caso contrário, sugere valores conservadores dependentes de contexto.
*/
function suggestProtocolRecruitable(d){
  // defaults conservadores (ajustáveis por ti)
  const s = {
    step_peep: 2,
    step_time: 60,
    peep_max: 16,
    pplat_stop: 28,
    map_drop_stop: 10,
    spo2_stop: 85
  };

  // Heurísticas simples para sugerir mais conservador
  if(d.age_m!=null && d.age_m < 6){
    s.peep_max = 14;
    s.pplat_stop = 26;
  }
  if(d.vaso==="yes"){
    s.map_drop_stop = 8;
    s.peep_max = Math.min(s.peep_max, 14);
  }
  if(d.compliance_hint==="worsens_with_peep"){
    s.peep_max = Math.min(s.peep_max, 14);
  }

  // Se utilizador já definiu, respeita
  return {
    step_peep: d.step_peep ?? s.step_peep,
    step_time: d.step_time ?? s.step_time,
    peep_max: d.peep_max ?? s.peep_max,
    pplat_stop: d.pplat_stop ?? s.pplat_stop,
    map_drop_stop: d.map_drop_stop ?? s.map_drop_stop,
    spo2_stop: d.spo2_stop ?? s.spo2_stop,
    source: (d.step_peep||d.step_time||d.peep_max||d.pplat_stop||d.map_drop_stop||d.spo2_stop) ? "manual" : "suggested"
  };
}

function buildStepSequence(peep0, step, peepMax){
  if(peep0==null || step==null || peepMax==null) return [];
  const steps = [];
  const n = Math.max(1, Math.round((peepMax - peep0)/step));
  for(let i=1;i<=n;i++){
    const peepTarget = peep0 + i*step;
    if(peepTarget > peepMax + 1e-9) break;
    steps.push({i, peepTarget});
  }
  return steps;
}

/* --------- Evaluate --------- */
function evaluate(d){
  const fired = [];
  let benefit = 0, risk = 0;

  // minimal sanity
  if(d.fio2==null || d.spo2==null) addRule(fired,"warn","Oxigenação incompleta","Ideal: FiO₂ e SpO₂; PaO₂ opcional para P/F.");
  if(d.map==null) addRule(fired,"warn","Hemodinâmica incompleta","MAP/PAM recomendado.");
  if(d.peep==null) addRule(fired,"warn","Ventilação incompleta","PEEP actual necessário para sequência stepwise.");

  // hard stop
  if(d.air_leak==="yes"){
    addRule(fired,"bad","Suspeita/risco de fuga aérea ou pneumotórax não drenado","ARM/pressões elevadas podem ser perigosas.");
    risk += 5;
  }

  // sedation
  if(d.sedation==="no"){
    addRule(fired,"warn","Sedação/sincronia não optimizadas","Asincronia aumenta risco e reduz eficácia da manobra.");
    risk += 2;
  }

  // vasoactives
  if(d.vaso==="yes"){
    addRule(fired,"warn","Vasoactivos em escalada","Aumento de pressão intratorácica pode piorar retorno venoso.");
    risk += 2;
  }

  // dp info
  if(d.dp!=null){
    addRule(fired,"info","Driving pressure disponível",`DP=${d.dp.toFixed(1)} cmH₂O (Pplat-PEEP).`);
    if(d.dp>=16){ addRule(fired,"warn","DP elevado (limiar ajustável)","Reforçar estratégia protetora e limites de pressão."); risk += 2; }
    else benefit += 1;
  }

  // recruitability hint
  if(d.mode==="recruitable"){
    if(d.compliance_hint==="improves_with_peep"){ addRule(fired,"info","Recrutabilidade provável","Complacência melhora com ↑PEEP."); benefit += 2; }
    if(d.compliance_hint==="worsens_with_peep"){ addRule(fired,"warn","Possível não-recrutável/hiperinsuflação","Complacência piora com ↑PEEP."); risk += 2; }
  }

  // obstructive
  if(d.mode==="obstructive"){
    addRule(fired,"info","Modo Obstrutivo","ARM clássica não recomendada; foco anti-auto-PEEP/hiperinsuflação.");
    if(d.auto_peep==="yes"){ addRule(fired,"warn","Auto-PEEP presente/suspeita","Evitar escalada de PEEP/pressões; vigiar hemodinâmica."); risk += 2; }
    if(d.bronchospasm==="yes"){ addRule(fired,"warn","Broncoespasmo dominante","Evitar empilhamento; priorizar expiração e monitorização."); risk += 1; }
  }

  // oxygen severity (coarse)
  if(d.fio2!=null && d.spo2!=null){
    if(d.spo2<88 && d.fio2>=0.6){ addRule(fired,"info","Hipoxemia relevante","SpO₂ baixa com FiO₂ alta pode justificar optimização (inclui ARM se recrutável)."); benefit += 2; }
    if(d.spo2>=92 && d.fio2<=0.4 && d.mode==="recruitable"){ addRule(fired,"warn","Oxigenação já razoável","Benefício potencial de ARM pode ser baixo; depende do contexto."); risk += 1; }
  }

  const hardStop = fired.some(r=>r.level==="bad");
  const score = benefit - risk;

  let status="Cautela", cls="warn";
  if(hardStop){ status="NÃO RECOMENDADO (hard stop)"; cls="bad"; }
  else if(d.mode==="obstructive"){
    status = (risk>=3) ? "Cautela — guia obstrutivo (sem ARM)" : "Guia obstrutivo (sem ARM)";
    cls = (risk>=3) ? "warn" : "good";
  } else {
    if(score>=2){ status="ARM possível / provável benefício (com protocolo)"; cls="good"; }
    else if(score<=-2){ status="ARM desfavorável (risco/benefício)"; cls="warn"; }
    else status="Cautela (optimizar/mais dados)";
  }

  return {fired, hardStop, status, cls, benefit, risk, score};
}

/* --------- Outputs builders --------- */
function buildMetrics(d, ev){
  const lines = [];
  lines.push(`Modo: ${d.mode==="recruitable" ? "Recrutável" : "Obstrutivo"} | Preset: ${d.preset || "—"}`);
  if(d.dp!=null) lines.push(`DP: ${d.dp.toFixed(1)} cmH₂O`);
  if(d.pf!=null) lines.push(`P/F: ${Math.round(d.pf)} (PaO₂/FiO₂)`);
  if(d.fio2!=null && d.spo2!=null) lines.push(`FiO₂: ${d.fio2} | SpO₂: ${d.spo2}%`);
  if(d.map!=null) lines.push(`MAP: ${d.map} mmHg | Vasoactivos: ${d.vaso}`);
  lines.push(`Score (benefício-risco): ${ev.score} (benefício=${ev.benefit}, risco=${ev.risk})`);
  return `<div class="mono" style="white-space:pre-wrap">${escapeHtml(lines.join("\n"))}</div>`;
}

function buildProtocolAndSteps(d, ev){
  if(d.mode==="obstructive"){
    return `<div class="warnbox"><b class="warn">Sem ARM clássica</b>. Em obstrutivo, a app não sugere protocolo de recrutamento; ver tab <b>Manual</b> e <b>Fluxograma</b>.</div>`;
  }

  if(ev.hardStop){
    return `<div class="badbox"><b class="bad">Hard stop</b>: não sugerir ARM/protocolo enquanto houver risco de fuga aérea/pneumotórax não drenado.</div>`;
  }

  const p = suggestProtocolRecruitable(d);
  const steps = buildStepSequence(d.peep, p.step_peep, p.peep_max);

  const src = (p.source==="suggested")
    ? `<span class="tag"><b class="good">SUGERIDO</b> parâmetros auto-preenchidos</span>`
    : `<span class="tag"><b class="warn">MANUAL</b> parâmetros fornecidos por ti</span>`;

  const gate = d.senior_ok
    ? `<div class="okbox"><b class="good">Validado por sénior</b>: guia executável (seguir protocolo institucional).</div>`
    : `<div class="warnbox"><b class="warn">Bloqueado</b>: para guia executável, assinala <b>Validação sénior</b>.</div>`;

  if(d.peep==null){
    return `${gate}<div class="warnbox"><b class="warn">Falta PEEP actual</b>: sem PEEP actual não é possível gerar sequência.</div>`;
  }

  if(!steps.length){
    return `${gate}${src}
      <div class="warnbox"><b class="warn">Sem sequência</b>: faltam parâmetros suficientes para gerar steps.</div>`;
  }

  const crit = `Parar se: SpO₂ &lt; ${p.spo2_stop}% ; queda MAP ≥ ${p.map_drop_stop} mmHg ; Pplat ≥ ${p.pplat_stop} cmH₂O ; ou intolerância clínica.`;

  const stepHtml = `
    <div class="okbox">
      <b class="good">Sequência stepwise (PEEP)</b><br>
      ${src}
      <ol class="list">
        ${steps.map(s=>`<li>PEEP → <span class="mono">${s.peepTarget.toFixed(1)}</span> cmH₂O durante <span class="mono">${p.step_time}</span>s; reavaliar (SpO₂, MAP, EtCO₂/ventilação, mecânica).</li>`).join("")}
        <li>Depois: titulação de “PEEP de manutenção” conforme resposta e protocolo local; documentar.</li>
      </ol>
      <div class="small" style="margin-top:8px">${crit}</div>
      <div class="small" style="margin-top:8px;color:var(--muted)">
        Parâmetros: step=${p.step_peep} | tempo=${p.step_time}s | PEEPmax=${p.peep_max} | stopPplat=${p.pplat_stop} | stopMAPdrop=${p.map_drop_stop} | stopSpO₂=${p.spo2_stop}
      </div>
    </div>
  `;

  return `${gate}${stepHtml}${d.local_protocol ? `<div class="box" style="margin-top:10px"><b>Nota protocolo local</b><div class="small" style="margin-top:6px;white-space:pre-wrap">${escapeHtml(d.local_protocol)}</div></div>` : ""}`;
}

function buildManual(d, ev){
  if(ev.hardStop){
    return `<div class="badbox"><b class="bad">Hard stop</b>: parar e estabilizar/excluir fuga aérea/pneumotórax; reavaliar indicação.</div>`;
  }

  if(d.mode==="obstructive"){
    const gate = d.senior_ok
      ? `<div class="okbox"><b class="good">Validado por sénior</b>: guia executável (seguir protocolo institucional).</div>`
      : `<div class="warnbox"><b class="warn">Bloqueado</b>: para guia executável, assinala <b>Validação sénior</b>.</div>`;

    return `${gate}
      <div class="warnbox">
        <b class="warn">Obstrutivo — sem ARM clássica</b>
        <ol class="list">
          <li><b>Confirmar obstrução dominante</b> e excluir tubo/secreções/pneumotórax.</li>
          <li><b>Evitar empilhamento</b>: garantir tempo expiratório suficiente; vigiar capnografia e sinais de hiperinsuflação.</li>
          <li><b>Vigiar hemodinâmica</b>: se deteriora com ↑pressões, reverter e reavaliar.</li>
          <li><b>PEEP externa</b>: apenas se indicado e sob protocolo, com vigilância de auto-PEEP.</li>
        </ol>
      </div>
      ${d.local_protocol ? `<div class="box" style="margin-top:10px"><b>Protocolo local</b><div class="small" style="margin-top:6px;white-space:pre-wrap">${escapeHtml(d.local_protocol)}</div></div>` : ""}`;
  }

  // recruitable manual how-to
  const p = suggestProtocolRecruitable(d);
  const gate = d.senior_ok
    ? `<div class="okbox"><b class="good">Validado por sénior</b>: guia executável (seguir protocolo institucional).</div>`
    : `<div class="warnbox"><b class="warn">Bloqueado</b>: para guia executável, assinala <b>Validação sénior</b>.</div>`;

  return `${gate}
    <div class="box">
      <b>Antes</b>
      <ul class="list">
        <li>Definir indicação/objetivo e confirmar que a hipótese é <b>colapso recrutável</b>.</li>
        <li>Preparar monitorização: SpO₂ contínua, PA/MAP (ideal invasiva), EtCO₂, pressões; registar baseline.</li>
        <li>Optimizar sincronia (sedação/analgesia; conforme protocolo institucional).</li>
        <li>Definir critérios de paragem: SpO₂&lt;${p.spo2_stop}%, queda MAP≥${p.map_drop_stop} mmHg, Pplat≥${p.pplat_stop} cmH₂O, ou sinais clínicos.</li>
      </ul>
    </div>
    <div class="box" style="margin-top:10px">
      <b>Durante (stepwise PEEP)</b>
      <ul class="list">
        <li>Subir PEEP em steps; manter cada step por ${p.step_time}s; reavaliar a cada step.</li>
        <li>Se não houver melhoria ou houver deterioração hemodinâmica/mecânica → reduzir e reavaliar.</li>
      </ul>
    </div>
    <div class="box" style="margin-top:10px">
      <b>Depois</b>
      <ul class="list">
        <li>Titular PEEP de manutenção (o menor PEEP que mantém ganho em oxigenação/mecânica com DP aceitável).</li>
        <li>Reavaliar 5–15 min e documentar resposta.</li>
      </ul>
    </div>
    ${d.local_protocol ? `<div class="box" style="margin-top:10px"><b>Protocolo local</b><div class="small" style="margin-top:6px;white-space:pre-wrap">${escapeHtml(d.local_protocol)}</div></div>` : ""}`;
}

function buildChecklist(d){
  const base = [
    "Indicação/objetivo definido e comunicado.",
    "Monitorização pronta: SpO₂, PA/MAP, EtCO₂; alarmes adequados.",
    "Avaliado risco de fuga aérea/pneumotórax; plano de resposta.",
    "Sincronia optimizada (sedação/analgesia) conforme protocolo.",
    "Critérios de paragem definidos antes de iniciar.",
    "Documentar baseline, passos e resposta."
  ];
  const obstExtra = [
    "Excluir tubo/secreções como causa principal.",
    "Vigiar sinais de auto-PEEP/hiperinsuflação e hemodinâmica."
  ];

  const items = (d.mode==="obstructive") ? [...base, ...obstExtra] : base;
  return `<ul class="list">${items.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>`;
}

function buildFlow(d, ev){
  const mk = (title, body, cls="flowstep") =>
    `<div class="${cls}"><b>${escapeHtml(title)}</b><div class="small" style="margin-top:6px">${body}</div></div>`;

  if(d.mode==="obstructive"){
    return `
      <div class="flowbox">
        ${mk("1) Identificar padrão obstrutivo", "Se broncoespasmo/auto-PEEP provável → evitar ARM clássica.")}
        <div class="flowarrow">↓</div>
        ${mk("2) Hard stops", (ev.hardStop ? "<span class='bad'>Fuga aérea/pneumotórax não drenado</span> → estabilizar antes de qualquer escalada." : "Sem hard stop detectado."))}
        <div class="flowarrow">↓</div>
        ${mk("3) Estratégia", "Foco: evitar empilhamento, garantir expiração, vigiar hemodinâmica; PEEP externa apenas sob protocolo e com cautela.")}
        <div class="flowarrow">↓</div>
        ${mk("4) Validação", (d.senior_ok ? "<span class='good'>Validado por sénior</span> → guia executável." : "<span class='warn'>Sem validação sénior</span> → guia educativo."))}
      </div>
    `;
  }

  return `
    <div class="flowbox">
      ${mk("1) Confirmar recrutabilidade", "Sugestões: hipoxemia relevante + mecânica compatível + complacência melhora com ↑PEEP (se disponível).")}
      <div class="flowarrow">↓</div>
      ${mk("2) Hard stops", (ev.hardStop ? "<span class='bad'>Fuga aérea/pneumotórax não drenado</span> → não fazer ARM." : "Sem hard stop detectado."))}
      <div class="flowarrow">↓</div>
      ${mk("3) Risco/benefício", `Score = benefício(${ev.benefit}) − risco(${ev.risk}) = <b>${ev.score}</b>.`)}
      <div class="flowarrow">↓</div>
      ${mk("4) Protocolo stepwise", "Se favorável: sequência stepwise + critérios de paragem + titulação de PEEP de manutenção.")}
      <div class="flowarrow">↓</div>
      ${mk("5) Validação", (d.senior_ok ? "<span class='good'>Validado por sénior</span> → guia executável." : "<span class='warn'>Sem validação sénior</span> → guia educativo."))}
    </div>
  `;
}

/* --------- Chart --------- */
function drawPeepChart(steps, peep0){
  const c = $("peepChart");
  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);

  const pad = 34, w=c.width, h=c.height;
  ctx.strokeStyle = "rgba(230,240,255,0.22)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(pad,pad); ctx.lineTo(pad,h-pad); ctx.lineTo(w-pad,h-pad);
  ctx.stroke();

  ctx.fillStyle = "rgba(231,238,252,0.85)";
  ctx.font = "14px system-ui";
  ctx.fillText("Sequência PEEP", pad, 20);

  if(!steps || !steps.length || peep0==null){
    ctx.fillStyle = "rgba(138,160,194,0.9)";
    ctx.font = "12px system-ui";
    ctx.fillText("Sem sequência (modo obstrutivo ou faltam parâmetros/PEEP).", pad, pad+18);
    return;
  }

  const values = [peep0, ...steps.map(s=>s.peepTarget)];
  const minV = Math.min(...values), maxV = Math.max(...values);
  const yMin = minV - 1, yMax = maxV + 1;

  const x0=pad, x1=w-pad, y0=h-pad, y1=pad;
  const xAt=(i)=> x0 + (x1-x0)*(i/(values.length-1));
  const yAt=(v)=> y0 - (y0-y1)*((v-yMin)/(yMax-yMin || 1));

  ctx.strokeStyle = "rgba(231,238,252,0.75)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  values.forEach((v,i)=>{ const x=xAt(i), y=yAt(v); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
  ctx.stroke();

  ctx.fillStyle = "rgba(231,238,252,0.85)";
  ctx.font = "11px ui-monospace, Menlo, Consolas";
  values.forEach((v,i)=>{
    const x=xAt(i), y=yAt(v);
    ctx.beginPath(); ctx.arc(x,y,3.2,0,Math.PI*2); ctx.fill();
    ctx.fillText(String(Math.round(v*10)/10), x-8, y-10);
  });
}

/* --------- Note / PDF / Copy --------- */
function buildNote(d, ev, protocolSteps){
  const now = new Date();
  const stamp = now.toISOString().slice(0,19).replace("T"," ");
  const firedTxt = ev.fired.map(r=>`- [${r.level.toUpperCase()}] ${r.title}${r.detail ? " — " + r.detail : ""}`).join("\n");

  const p = (d.mode==="recruitable" && !ev.hardStop) ? suggestProtocolRecruitable(d) : null;
  const stepsTxt = (protocolSteps && protocolSteps.length)
    ? protocolSteps.map(s=>`- PEEP ${s.peepTarget.toFixed(1)} por ${p.step_time}s`).join("\n")
    : "—";

  return `Pulmoniq — Pediatric ARM (educacional) | ${stamp}
Modo: ${d.mode==="recruitable" ? "Recrutável" : "Obstrutivo"} | Preset: ${d.preset || "—"}
Validação sénior: ${d.senior_ok ? "SIM" : "NÃO"}

Dx/Objetivo: ${d.dx || "—"} | ${d.goal || "—"}

Dados:
- Peso: ${d.weight ?? "—"} kg | Idade: ${d.age_m ?? "—"} meses
- FiO2: ${d.fio2 ?? "—"} | SpO2: ${d.spo2 ?? "—"}% | PaO2: ${d.pao2 ?? "—"} | P/F: ${d.pf!=null ? Math.round(d.pf) : "—"}
- PaCO2: ${d.paco2 ?? "—"} | MAP: ${d.map ?? "—"} | Vaso: ${d.vaso}
- Vent: ${d.vent_mode} | PEEP: ${d.peep ?? "—"} | Pplat: ${d.pplat ?? "—"} | PIP: ${d.pip ?? "—"} | Vt: ${d.vt_mlkg ?? "—"} | DP: ${d.dp ?? "—"}
- Segurança: air_leak=${d.air_leak} | sedação=${d.sedation}

Resultado: ${ev.status}

Regras activadas:
${firedTxt || "—"}

Protocolo/Sequência:
${(d.mode==="recruitable" && !ev.hardStop) ? (
`Parâmetros: step=${p.step_peep} | tempo=${p.step_time}s | PEEPmax=${p.peep_max} | stopPplat=${p.pplat_stop} | stopMAPdrop=${p.map_drop_stop} | stopSpO2=${p.spo2_stop}
Steps:
${stepsTxt}
Critérios de paragem: SpO2<${p.spo2_stop}%, queda MAP≥${p.map_drop_stop}, Pplat≥${p.pplat_stop} ou intolerância.`
) : "Sem ARM clássica / ou hard stop."}

Notas protocolo local:
${d.local_protocol || "—"}
`;
}

$("copyNote").addEventListener("click", async ()=>{
  try{
    await navigator.clipboard.writeText($("noteOut").value || "");
    $("copyNote").textContent="Copiado ✓";
    setTimeout(()=>$("copyNote").textContent="Copiar registo", 1200);
  }catch(e){
    alert("Cópia automática falhou. Copia manualmente.");
  }
});

$("pdfBtn").addEventListener("click", ()=>{
  const note = $("noteOut").value || "";
  const html = `<!doctype html><html><head><meta charset="utf-8">
<title>Pulmoniq - Registo</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:24px}
pre{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;line-height:1.35}
h1{font-size:16px;margin:0 0 12px}
.small{color:#444;font-size:12px;margin-bottom:12px}
</style></head><body>
<h1>Pulmoniq — Pediatric ARM (Registo)</h1>
<div class="small">Gerado pela app. Validar com protocolo institucional e sénior responsável.</div>
<pre>${escapeHtml(note)}</pre>
<script>window.onload=()=>{window.print();}</script>
</body></html>`;
  const w = window.open("", "_blank");
  w.document.open(); w.document.write(html); w.document.close();
});

/* --------- Run --------- */
function renderStatus(d, ev){
  $("statusBadge").textContent = ev.status;
  $("statusBadge").className = "badge " + (ev.cls==="good"?"good":ev.cls==="bad"?"bad":"warn");

  const meta = [];
  if(d.dp!=null) meta.push(`DP ${d.dp.toFixed(1)}`);
  if(d.pf!=null) meta.push(`P/F ${Math.round(d.pf)}`);
  if(d.peep!=null) meta.push(`PEEP ${d.peep}`);
  if(d.map!=null) meta.push(`MAP ${d.map}`);
  meta.push(d.senior_ok ? "Sénior: OK" : "Sénior: NÃO");
  $("statusMeta").textContent = meta.join(" · ");

  $("statusSummary").textContent =
    (d.mode==="recruitable")
    ? "Recrutável: mostra cálculo e sugere protocolo stepwise (bloqueado como executável sem validação sénior)."
    : "Obstrutivo: não sugere ARM clássica; guia estruturado anti-auto-PEEP (bloqueado sem validação sénior).";
}

function run(){
  const d = derive(collect());
  const ev = evaluate(d);

  // Outputs
  $("rulesFired").innerHTML = renderRules(ev.fired);
  $("metricsOut").innerHTML = buildMetrics(d, ev);
  $("protocolOut").innerHTML = buildProtocolAndSteps(d, ev);
  $("guideOut").innerHTML = buildManual(d, ev);
  $("checklistOut").innerHTML = buildChecklist(d);
  $("flowOut").innerHTML = buildFlow(d, ev);

  // Chart steps
  let steps = [];
  if(d.mode==="recruitable" && !ev.hardStop){
    const p = suggestProtocolRecruitable(d);
    steps = buildStepSequence(d.peep, p.step_peep, p.peep_max);
  }
  drawPeepChart(steps, d.peep);

  // Note
  $("noteOut").value = buildNote(d, ev, steps);

  // Status
  renderStatus(d, ev);
}

$("runBtn").addEventListener("click", run);

/* --------- Clear + Examples --------- */
$("clearBtn").addEventListener("click", ()=>{
  const ids = ["dx","goal","weight","age_m","fio2","spo2","pao2","paco2","map","peep","pplat","pip","vt_mlkg",
               "step_peep","step_time","peep_max","pplat_stop","map_drop_stop","spo2_stop","local_protocol"];
  ids.forEach(id=>$(id).value="");
  ["vaso","vent_mode","compliance_hint","air_leak","sedation","auto_peep","bronchospasm"].forEach(id=>$(id).selectedIndex=0);
  $("senior_ok").checked = false;
  $("mode").value="recruitable";
  showModeSpecific(); refreshPresetList(); applyPreset();

  $("rulesFired").textContent="—";
  $("metricsOut").textContent="—";
  $("protocolOut").textContent="—";
  $("guideOut").textContent="—";
  $("checklistOut").textContent="—";
  $("flowOut").textContent="—";
  $("noteOut").value="";
  $("statusBadge").textContent="—";
  $("statusBadge").className="badge";
  $("statusMeta").textContent="Sem avaliação";
  $("statusSummary").textContent="Preenche e carrega em Avaliar.";
  drawPeepChart([], null);
});

$("fillRecruit").addEventListener("click", ()=>{
  $("mode").value="recruitable";
  showModeSpecific(); refreshPresetList();
  $("preset").value="ards_generic";

  $("dx").value="ARDS / atelectasia (exemplo)";
  $("goal").value="Melhorar oxigenação e manter DP aceitável";
  $("weight").value="12";
  $("age_m").value="24";
  $("fio2").value="0.70";
  $("spo2").value="88";
  $("pao2").value="55";
  $("paco2").value="60";
  $("map").value="55";
  $("vaso").value="no";
  $("vent_mode").value="PC";
  $("peep").value="8";
  $("pplat").value="24";
  $("pip").value="30";
  $("vt_mlkg").value="6";
  $("compliance_hint").value="improves_with_peep";
  $("air_leak").value="no";
  $("sedation").value="yes";
  $("senior_ok").checked=true;

  // deixa parâmetros vazios para ver sugestão automática
  $("step_peep").value="";
  $("step_time").value="";
  $("peep_max").value="";
  $("pplat_stop").value="";
  $("map_drop_stop").value="";
  $("spo2_stop").value="";
  $("local_protocol").value="(Cole aqui o protocolo institucional.)";

  run();
});

$("fillObst").addEventListener("click", ()=>{
  $("mode").value="obstructive";
  showModeSpecific(); refreshPresetList();
  $("preset").value="asthma";

  $("dx").value="Asma grave (exemplo)";
  $("goal").value="Reduzir hiperinsuflação dinâmica; manter hemodinâmica";
  $("weight").value="18";
  $("age_m").value="96";
  $("fio2").value="0.40";
  $("spo2").value="92";
  $("pao2").value="";
  $("paco2").value="65";
  $("map").value="60";
  $("vaso").value="no";
  $("vent_mode").value="PC";
  $("peep").value="5";
  $("pplat").value="";
  $("pip").value="32";
  $("vt_mlkg").value="";
  $("auto_peep").value="yes";
  $("bronchospasm").value="yes";
  $("air_leak").value="unknown";
  $("sedation").value="yes";
  $("senior_ok").checked=true;

  run();
});

/* --------- PWA SW --------- */
if("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}
</script>
</body>
</html>
